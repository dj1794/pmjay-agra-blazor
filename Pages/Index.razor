@page "/"
@using System.Linq
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Forms
@using PmjayAgra.Blazor.Data
@inject PmjayAgra.Blazor.Data.AgraDataService DataService
@inject IJSRuntime JS

<style>
    /* Styles ported from INDEXRef.HTML (simplified) */
    body {
        font-family: Arial, sans-serif;
        background: #f4f6f8;
        padding: 20px;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 10px;
    }

        .header img {
            height: 70px;
        }

    h2, h4 {
        text-align: center;
        margin: 4px0;
    }

    .filters {
        background: #fff;
        padding: 15px;
        border-radius: 6px;
        display: grid;
        grid-template-columns: repeat(4,1fr);
        gap: 12px;
        margin-bottom: 15px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

        .filter-group label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .filter-group input, .filter-group select {
            padding: 7px;
            font-size: 13px;
        }

    .summary {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .card {
        flex: 1;
        background: #fff;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 01px4px rgba(0,0,0,0.1);
    }

        .card b {
            font-size: 18px;
            color: #007bff;
        }

    .actions {
        text-align: right;
        margin-bottom: 10px;
    }

    button {
        padding: 8px12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: #fff;
    }

    .download {
        background: #28a745;
    }

    .print {
        background: #6c757d;
    }

    .btn-primary, .btn-apply {
        background: #007bff;
        color: #fff;
        border: none;
    }

        .btn-primary:hover, .btn-apply:hover {
            filter: brightness(0.95);
        }

    .table-wrapper {
        background: #fff;
        padding: 8px;
        border-radius: 6px;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        font-size: 12px;
    }

    th, td {
        border: 1px solid #ccc;
        padding: 6px;
    }

    th {
        background: #007bff;
        color: #fff;
        position: sticky;
        top: 0;
    }

    tr:nth-child(even) {
        background: #f2f2f2;
    }

    .pager {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
    }

    /* Loader overlay */
    .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loader-box {
        background: #fff;
        padding: 18px24px;
        border-radius: 8px;
        box-shadow: 02px10px rgba(0,0,0,0.2);
        font-weight: bold;
    }
    /* PRINT */
    @@media print {
        .filters, .actions {
            display: none;
        }

        body {
            background: white;
        }

        th {
            background: #ddd !important;
            color: black !important;
        }
    }
</style>

<div class="header">
    <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Emblem_of_India.svg" alt="Emblem">
    <img src="https://mera.pmjay.gov.in/images/logo.png" alt="PMJAY">
</div>

<h2>Ayushman Bharat – PMJAY Data</h2>
<h4>District Agra</h4>

<!-- FILTERS -->
<div class="filters">
    <div class="filter-group">
        <label>Search (Name / Family ID)</label>
        <div style="display:flex; gap:8px; align-items:center;">
            <InputText @bind-Value="Search" />            
        </div>
        <!-- debug message -->
        <div style="margin-top:6px; font-size:12px; color:#666;">@LastAction</div>
    </div>


    <div class="filter-group">
        <label>Block</label>
        <InputSelect @bind-Value="Block" @onchange="OnBlockChanged">
            <option value="">All</option>
            @foreach (var b in Blocks)
            {
                <option value="@b">@b</option>
            }
        </InputSelect>
    </div>

    <div class="filter-group">
        <label>Village / Ward</label>
        <InputSelect @bind-Value="Village">
            <option value="">All</option>
            <option value="VILLAGE1">VILLAGE1</option>
            <option value="VILLAGE2">VILLAGE2</option>
        </InputSelect>
    </div>

    <div class="filter-group">
        <label>Rural / Urban</label>
        <InputSelect @bind-Value="RU">
            <option value="">All</option>
            <option value="RURAL">RURAL</option>
            <option value="URBAN">URBAN</option>
        </InputSelect>
    </div>

    <div class="filter-group">
        <label>Source Type</label>
        <InputSelect @bind-Value="Source">
            <option value="">All</option>
            <option value="SECC">SECC</option>
            <option value="TPHH">TPHH</option>
            <option value="MMJAA">MMJAA</option>
            <option value="STPHH">STPHH</option>
            <option value="BOCW">BOCW</option>
        </InputSelect>
    </div>

    <div class="filter-group">
        <label>Member Status</label>
        <InputSelect @bind-Value="MemberStatus">
            <option value="">All</option>
            <option value="Approved">Approved</option>
            <option value="Disabled">Disabled</option>
            <option value="Applied">Applied</option>
            <option value="KYC needed">KYC needed</option>
        </InputSelect>
    </div>

    <div class="filter-group">
        <label>Family Status</label>
        <InputSelect @bind-Value="FamilyStatus">
            <option value="">All</option>
            <option value="ACTIVE">ACTIVE</option>
            <option value="INACTIVE">INACTIVE</option>
        </InputSelect>
    </div>
    <button type="button" @onclick="Reset" class="btn btn-outline-primary">Reset</button>

    <button type="button" @onclick="ApplyFiltersClicked" disabled="@(IsLoading || !IsInteractive)">Apply Filters</button>
</div>

<!-- DEBUG: current filters (remove in production) -->
<div style="margin:6px0; font-size:12px; color:#333;">Filters: Block=@Block | Village=@Village | R/U=@RU | Source=@Source | MemberStatus=@MemberStatus | FamilyStatus=@FamilyStatus | PageSize=@PageSize</div>

<!-- Loader -->
@if (IsLoading)
{
    <div class="loader-overlay">
        <div class="loader-box">Loading…</div>
    </div>
}

<!-- SUMMARY -->
<div class="summary">
    <div class="card">Total Families<br><b>@Summary.TotalFamilies</b></div>
    <div class="card">Total Members<br><b>@Summary.TotalMembers</b></div>
    <div class="card">Covered Members<br><b>@Summary.CoveredMembers</b></div>
    <div class="card">Covered Families<br><b>@Summary.CoveredFamilies</b></div>
</div>

<div class="actions">
    <button type="button" class="download" @onclick="ExportCsv">Download Excel</button>
    <button type="button" class="print" @onclick="Print">Print</button>
</div>

<div class="table-wrapper">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:8px;">
        <div>
            <label>Page size: </label>
            <select @bind="PageSize">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="100">100</option>
                <option value="250">250</option>
            </select>
        </div>
        <div>Showing @((CurrentPage - 1) * PageSize + 1)-@Math.Min(CurrentPage * PageSize, Total) of @Total</div>
    </div>

    <table class="table">
        <thead>
            <tr>
                @foreach (var h in Headers)
                {
                    <th>@h</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var r in DisplayRows)
            {
                <tr>
                    @foreach (var h in Headers)
                    {
                        <td>@(GetValue(r, h) ?? string.Empty)</td>
                    }
                </tr>
            }
        </tbody>
    </table>

    <div class="pager">
        <button type="button" @onclick="First">First</button>
        <button type="button" @onclick="Prev">Prev</button>
        <span>Page @CurrentPage of @TotalPages</span>
        <button type="button" @onclick="Next">Next</button>
        <button type="button" @onclick="Last">Last</button>
    </div>
</div>

@code {
    readonly List<string> Blocks = new()
 {
 "ACHHNERA",
 "AKOLA",
 "BAH",
 "BARAULI AHIR",
 "BICHPURI",
 "ETMADPUR",
 "FATEHABAD",
 "FATEHPUR SIKRI",
 "JAGNER",
 "JAITPUR KALAN",
 "KHANDAULI",
 "KHERAGARH",
 "PINAHAT",
 "SAIYAN",
 "SHAMSABAD",
 "M.cCORP"
 };

    // Use DTO property names as the headers (these match the keys produced by DataService)
    readonly List<string> DtoHeaders = new()
 {
 "src_family_id",
 "src_member_id",
 "name",
 "relation",
 "father_guardian_name",
 "rural_urban_flag",
 "district_name",
 "blockname",
 "source_address",
 "addressasperadhaarofapproved",
 "village_ward_lgd_code",
 "source_type",
 "card_status_member",
 "card_status_family",
 "memberbelongtozeropovery"
 };

    List<string> Headers = new();
    List<Dictionary<string, object?>> Rows = new();
    List<Dictionary<string, object?>> DisplayRows = new();

    SummaryDto Summary = new();

    // Filters
    string Search = string.Empty;
    string District = string.Empty;
    string Block { get; set; } = string.Empty;
    string Village { get; set; } = string.Empty;
    string RU { get; set; } = string.Empty;
    string Source { get; set; } = string.Empty;
    string MemberStatus { get; set; } = string.Empty;
    string FamilyStatus { get; set; } = string.Empty;

    int Total = 0;
    int CurrentPage = 1;
    int PageSize { get; set; } = 10; // default to10
    int TotalPages => Math.Max(1, (int)Math.Ceiling((double)Total / PageSize));

    // Loading flag for overlay
    bool IsLoading { get; set; } = false;

    // interactive flag — set after first render so we know Blazor Server connection is active
    bool IsInteractive { get; set; } = false;

    int TotalFamilies => Summary.TotalFamilies;
    int TotalMembers => Summary.TotalMembers;
    int CoveredMembers => Summary.CoveredMembers;
    int CoveredFamilies => Summary.CoveredFamilies;

    // debug message to verify handler runs
    string LastAction { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadPage();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // mark interactive and log to console
            IsInteractive = true;
            LastAction = "Blazor interactive";
            // safe to call JS now
            await JS.InvokeVoidAsync("console.log", LastAction);
            StateHasChanged();
        }
    }

    async Task LoadPage()
    {
        IsLoading = true;
        try
        {
            Summary = await DataService.GetFilteredSummaryAsync(Block, Village, RU, Source, MemberStatus, FamilyStatus, Search);
            Total = Summary.TotalMembers;
            Rows = await DataService.GetPageAsync(CurrentPage, PageSize, Block, Village, RU, Source, MemberStatus, FamilyStatus, Search);
            // Only keep headers that are defined in the DTO and appear in the row keys
            var firstKeys = Rows.FirstOrDefault()?.Keys ?? Enumerable.Empty<string>();
            Headers = DtoHeaders.Where(h => firstKeys.Contains(h, StringComparer.OrdinalIgnoreCase)).ToList();
            // Use server-side filtered rows directly (avoid re-filtering client-side which can mismatch keys)
            DisplayRows = Rows.ToList();
            // Debug: log selected block and sample keys to browser console (only when interactive)
            if (IsInteractive)
            {
                await JS.InvokeVoidAsync("console.log", $"LoadPage: Block='{Block}', Rows.Count={Rows.Count}");
                await JS.InvokeVoidAsync("console.log", $"First row keys: {string.Join(',', firstKeys)}");
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    void ApplyFilters()
    {
        // Guard against null Rows
        if (Rows == null)
        {
            DisplayRows = new List<Dictionary<string, object?>>();
            StateHasChanged();
            return;
        }

        DisplayRows = Rows.Where(RowMatchesFilters).ToList();
        StateHasChanged();
    }

    bool RowMatchesFilters(Dictionary<string, object?> r)
    {
        string Get(string key) => (GetValue(r, key) ?? string.Empty).ToString();

        // Normalize inputs
        var search = (Search ?? string.Empty).Trim();
        var district = (District ?? string.Empty).Trim();
        var block = (Block ?? string.Empty).Trim();
        var village = (Village ?? string.Empty).Trim();
        var ru = (RU ?? string.Empty).Trim();
        var source = (Source ?? string.Empty).Trim();
        var memberStatus = (MemberStatus ?? string.Empty).Trim();
        var familyStatus = (FamilyStatus ?? string.Empty).Trim();

        // Search: match name OR family id
        if (!string.IsNullOrWhiteSpace(search))
        {
            var name = Get("name");
            var fid = Get("src_family_id");
            if (name.IndexOf(search, StringComparison.OrdinalIgnoreCase) <0 && fid.IndexOf(search, StringComparison.OrdinalIgnoreCase) <0)
                return false;
        }

        if (!IsMatch(district, () => string.Equals(Get("district_name"), district, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(block, () => string.Equals(Get("blockname"), block, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(village, () => Get("village_ward_lgd_code").IndexOf(village, StringComparison.OrdinalIgnoreCase) >=0))
            return false;
        if (!IsMatch(ru, () => string.Equals(Get("rural_urban_flag"), ru, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(source, () => string.Equals(Get("source_type"), source, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(memberStatus, () => string.Equals(Get("card_status_member"), memberStatus, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(familyStatus, () => string.Equals(Get("card_status_family"), familyStatus, StringComparison.OrdinalIgnoreCase)))
            return false;

        return true;
    }

    static bool IsMatch(string filter, Func<bool> matchFunc)
    {
        return string.IsNullOrWhiteSpace(filter) || matchFunc();
    }

    // Handler for Block dropdown change: request server-side filtered data
    async Task OnBlockChanged(ChangeEventArgs e)
    {
    // ensure Block gets the selected value (bind already does this but keep in sync)
    Block = (e?.Value?.ToString() ?? string.Empty).Trim();
    LastAction = $"Block changed to '{Block}' at {DateTime.UtcNow:O}";
    if (IsInteractive)
    {
        await JS.InvokeVoidAsync("console.log", LastAction);
    }

    CurrentPage =1;
    // reload page from the server with new Block filter so paging and summary are correct
    await LoadPage();
    }



    async Task ApplyFiltersClicked()
    {
        // diagnostic: set message and log to browser console
        LastAction = $"ApplyFiltersClicked invoked at {DateTime.UtcNow:O}";
        if (IsInteractive)
        {
            await JS.InvokeVoidAsync("console.log", LastAction);
        }

        CurrentPage = 1;
        await LoadPage();
    }

    string? GetValue(Dictionary<string, object?> row, string key)
    {
        if (row == null) return null;
        if (row.TryGetValue(key, out var v)) return v?.ToString();
        // try case-insensitive
        var found = row.FirstOrDefault(kv => string.Equals(kv.Key, key, StringComparison.OrdinalIgnoreCase));
        return found.Equals(default(KeyValuePair<string, object?>)) ? null : found.Value?.ToString();
    }

    int ComputeTotalFamilies()
    {
        return DisplayRows.Select(r => GetValue(r, "src_family_id")).Where(s => !string.IsNullOrEmpty(s)).Distinct(StringComparer.OrdinalIgnoreCase).Count();
    }

    async Task Prev() { if (CurrentPage > 1) { CurrentPage--; await LoadPage(); } }
    async Task Next() { if (CurrentPage < TotalPages) { CurrentPage++; await LoadPage(); } }
    async Task First() { if (CurrentPage != 1) { CurrentPage = 1; await LoadPage(); } }
    async Task Last() { if (CurrentPage != TotalPages) { CurrentPage = TotalPages; await LoadPage(); } }

    async Task ExportCsv()
    {
        var csv = new List<string>();
        csv.Add(string.Join(",", Headers.Select(h => '"' + h + '"')));
        foreach (var r in DisplayRows)
        {
            var row = Headers.Select(h => '"' + (GetValue(r, h) ?? string.Empty).Replace("\"", "''") + '"');
            csv.Add(string.Join(",", row));
        }
        var content = string.Join("\n", csv);
        await JS.InvokeVoidAsync("downloadBlob", content, "PMJAY_Agra_Data.csv");
    }

    async Task Print()
    {
        await JS.InvokeVoidAsync("print");
    }

    // Reset helper
    void Reset()
    {
        Search = string.Empty;
        Block = string.Empty;
        Village = string.Empty;
        RU = string.Empty;
        Source = string.Empty;
        MemberStatus = string.Empty;
        FamilyStatus = string.Empty;
        LastAction = "Filters reset";
    }
}

<!-- JS helpers -->
<script>
    window.downloadBlob = function(content, filename){
    var a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([content],{type:'text/csv'}));
    a.download=filename;
    a.click();
    };
</script>